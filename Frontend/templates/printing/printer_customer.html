{%extends "nav.html"%}
{%block title%}Printer Customer{%endblock%}
{%block extra_head%}

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

{%endblock%}
{%block content%}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-teal-50/30 to-cyan-50/30 p-6">

  <div class="max-w-[1800px] mx-auto space-y-6">

    <!-- HEADER -->
    <div
      class="bg-gradient-to-r from-teal-600 via-cyan-600 to-teal-600 rounded-xl p-6 shadow-xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4 md:gap-0">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-xl bg-white/20 flex items-center justify-center">
          <i data-lucide="users" class="text-white w-6 h-6"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-white">Customer Wise Report</h1>
          <p class="text-teal-100 text-sm">Production details grouped by customer</p>
        </div>
      </div>

      <button onclick="window.print()"
        class="bg-white/20 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-white/30">
        <i data-lucide="printer" class="w-4 h-4"></i>
        Print
      </button>
    </div>

    <!-- FILTERS -->
    <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
      <div>
        <label class="text-sm text-slate-600">From Date</label>
        <input id="fromDate" type="date" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="text-sm text-slate-600">To Date</label>
        <input id="toDate" type="date" class="w-full border rounded px-3 py-2">
      </div>

      <div class="md:col-span-2">
        <label class="text-sm text-slate-600">Customer Name</label>
        <input id="customerName" placeholder="Type Customer Name..." class="w-full border rounded px-3 py-2">
      </div>

      <div class="flex gap-2 justify-end">
        <button type="button" onclick="searchCustomer()"
          class="bg-teal-600 text-white px-6 py-2 rounded-lg shadow hover:scale-105 transition flex items-center gap-2">
          <i data-lucide="search" class="w-4 h-4"></i>
          Search
        </button>

        <button type="button" onclick="resetFilters()"
          class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg shadow hover:bg-gray-300 flex items-center gap-2">
          <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
          Reset
        </button>
      </div>
    </div>

    <!-- Found Records Strip (like 2nd image) -->
    <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg">
      <div id="foundStrip" class="px-6 py-4 text-slate-600 border-b">
        Found 0 Records
      </div>

      <!-- TABLE -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-3">S.No</th>
              <th class="p-3">Date</th>
              <th class="p-3">Jobcard No</th>
              <th class="p-3">Customer Name</th>
              <th class="p-3">Shift</th>
              <th class="p-3">Machine No</th>
              <th class="p-3">Operator</th>
              <th class="p-3">Particulars</th>
              <th class="p-3 text-right">Order Qty</th>
              <th class="p-3 text-right">Product Qty</th>
              <th class="p-3 text-right">Balance Qty</th>
            </tr>
          </thead>

          <tbody id="reportBody">
            <!-- rows will be shown/hidden by JS -->
            <tr class="border-t hover:bg-slate-50 data-row">
              <td class="p-3">1</td>
              <td class="p-3">10-04-2024</td>
              <td class="p-3">JC-2404-0085</td>
              <td class="p-3 customer-col">RHYTHM KNIT INDIA (P) LTD</td>
              <td class="p-3">DAY (09:00–21:00)</td>
              <td class="p-3">GT-1</td>
              <td class="p-3">SENTHIL</td>
              <td class="p-3">2XL TOP</td>
              <td class="p-3 text-right">225</td>
              <td class="p-3 text-right">225</td>
              <td class="p-3 text-right">0</td>
            </tr>

            <tr class="border-t hover:bg-slate-50 data-row">
              <td class="p-3">2</td>
              <td class="p-3">10-04-2024</td>
              <td class="p-3">JC-2404-0086</td>
              <td class="p-3 customer-col">RHYTHM KNIT INDIA (P) LTD</td>
              <td class="p-3">DAY (09:00–21:00)</td>
              <td class="p-3">GT-1</td>
              <td class="p-3">SENTHIL</td>
              <td class="p-3">AOP BOTTOM</td>
              <td class="p-3 text-right">5000</td>
              <td class="p-3 text-right">5000</td>
              <td class="p-3 text-right">0</td>
            </tr>
          </tbody>

          <tfoot class="bg-slate-100 font-semibold">
            <tr>
              <td colspan="8" class="p-3 text-right">Total</td>
              <td id="totOrder" class="p-3 text-right">0.00</td>
              <td id="totProd" class="p-3 text-right">0.00</td>
              <td id="totBal" class="p-3 text-right">0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

  </div>
</div>
{%endblock%}

{%block extra_js%}
<script>
  lucide.createIcons();

  function hideAllDataRows() {
    document.querySelectorAll(".data-row").forEach(r => r.style.display = "none");
  }

  function showHintRow(msg) {
    const tbody = document.getElementById("reportBody");
    let hint = document.getElementById("hintRow");
    if (!hint) {
      hint = document.createElement("tr");
      hint.id = "hintRow";
      hint.className = "border-t";
      tbody.prepend(hint);
    }
    hint.innerHTML = `<td colspan="11" class="p-6 text-center text-slate-500">${msg}</td>`;
    hint.style.display = "";
  }

  function removeHintRow() {
    const hint = document.getElementById("hintRow");
    if (hint) hint.remove();
  }

  function setFound(count) {
    document.getElementById("foundStrip").innerText = `Found ${count} Records`;
  }

  function setTotals(order, prod, bal) {
    document.getElementById("totOrder").innerText = order.toFixed(2);
    document.getElementById("totProd").innerText = prod.toFixed(2);
    document.getElementById("totBal").innerText = bal.toFixed(2);
  }

  // ✅ Search with alerts
  function searchCustomer() {
    const input = document.getElementById("customerName").value.trim().toUpperCase();

    // empty -> alert
    if (input === "") {
      alert("Please enter Customer Name");
      hideAllDataRows();
      removeHintRow();
      showHintRow("Enter Customer Name to view records");
      setFound(0);
      setTotals(0, 0, 0);
      return;
    }

    removeHintRow();

    let found = 0;
    let totalOrder = 0, totalProd = 0;

    document.querySelectorAll(".data-row").forEach(row => {
      const customer = row.querySelector(".customer-col").innerText.trim().toUpperCase();

      if (customer.includes(input)) {
        row.style.display = "";
        found++;

        // totals from columns (Order Qty)
        const order = parseFloat(row.children[8].innerText.replace(/,/g, '')) || 0;
        const prod = parseFloat(row.children[9].innerText.replace(/,/g, '')) || 0;
        totalOrder += order;
        totalProd += prod;
      } else {
        row.style.display = "none";
      }
    });

    if (found === 0) {
      alert("No records found for this Customer Name");
      hideAllDataRows();
      showHintRow("No Records");
      setFound(0);
      setTotals(0, 0, 0);
      return;
    }

    const bal = totalOrder - totalProd;
    setFound(found);
    setTotals(totalOrder, totalProd, bal);
  }

  // ✅ Reset
  function resetFilters() {
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    document.getElementById("customerName").value = "";

    hideAllDataRows();
    removeHintRow();
    showHintRow("Enter Customer Name to view records");
    setFound(0);
    setTotals(0, 0, 0);
  }

  // ✅ on load
  document.addEventListener("DOMContentLoaded", () => {
    hideAllDataRows();
    showHintRow("Enter Customer Name to view records");
    setFound(0);
    setTotals(0, 0, 0);
  });
</script>
{%endblock%}