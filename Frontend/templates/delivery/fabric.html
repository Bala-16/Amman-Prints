{% extends "nav.html" %}
{% block title %}Fabric Delivery Challan{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
{% endblock %}

{% block content %}

<div class="min-h-screen bg-slate-100 p-4 sm:p-6">

  <div class="max-w-[1600px] mx-auto space-y-6">

    <!-- HEADER -->
    <div
      class="bg-gradient-to-r from-teal-600 via-cyan-600 to-teal-600
             rounded-xl p-6 shadow-xl
             flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">

      <div class="flex items-center gap-4">
        <div class="h-14 w-14 rounded-xl bg-white/20 flex items-center justify-center">
          <i data-lucide="layers" class="w-8 h-8 text-white"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-white">Fabric Delivery Challan</h1>
          <p class="text-sm text-emerald-100">Fabric delivery & quantity tracking</p>
        </div>
      </div>

      <button onclick="openModal()"
        class="bg-white text-teal-700 hover:bg-teal-50
               px-5 py-2 rounded-lg shadow font-semibold">
        + Add Item
      </button>

    </div>

    <!-- FORM -->
    <div class="bg-white rounded-xl shadow p-5 border">
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 text-sm">

        <div>
          <label class="font-semibold text-slate-600">Delivery No *</label>
          <select class="formInput"><option>Select Delivery</option></select>
        </div>

        <div>
          <label class="font-semibold text-slate-600">Jobcard No *</label>
          <select class="formInput"><option>Select Jobcard</option></select>
        </div>

        <div>
          <label class="font-semibold text-slate-600">Customer Name *</label>
          <select class="formInput"><option>Select Customer</option></select>
        </div>

        <div>
          <label class="font-semibold text-slate-600">Fabric Type *</label>
          <select class="formInput"><option>Select Fabric</option></select>
        </div>

        <div>
          <label class="font-semibold text-slate-600">Total Qty</label>
          <input id="grandTotal" readonly
            class="formInput font-bold text-teal-700">
        </div>
        

      </div>
    </div>


    <!-- âœ… DESKTOP TABLE -->
    <div class="hidden md:block bg-white rounded-xl shadow border overflow-x-auto">

      <table class="w-full text-sm min-w-[1000px]">

        <thead class="bg-slate-50 text-slate-700">
          <tr>
            <th class="th">S.No</th>
            <th class="th">Date</th>
            <th class="th">Particulars</th>
            <th class="th">Width</th>
            <th class="th">Height</th>
            <th class="th">Qty</th>
            <th class="th">Action</th>
          </tr>
        </thead>

        <tbody id="challanBody"></tbody>

        <tfoot>
          <tr>
            <td colspan="7" class="p-5">

              <div class="flex justify-between items-center">

                <div class="font-bold text-teal-700 text-lg">
                  Total : <span id="totalQty">0</span>
                </div>

                <!-- FOOTER FIELDS -->
                <div id="footerBox" class="hidden flex gap-3 items-end">

                  <div>
                    <label class="font-semibold text-sm">Delivery Status *</label>
                    <select id="deliveryStatus" class="formInput w-40">
                      <option value="">Select</option>
                      <option>Pending</option>
                      <option>Completed</option>
                    </select>
                  </div>

                  <div>
                    <label class="font-semibold text-sm">Delivery Through *</label>
                    <select id="deliveryThrough" class="formInput w-40">
                      <option value="">Select</option>
                      <option>Own Vehicle</option>
                      <option>Courier</option>
                    </select>
                  </div>

                  <div>
                    <label class="font-semibold text-sm">Vehicle No *</label>
                    <input id="vehicleNo"
                      class="formInput w-40"
                      placeholder="TN01AB1234">
                  </div>

                  <div>
                    <label class="font-semibold text-sm">Remarks</label>
                    <textarea id="remarks"
                      rows="1"
                      class="formInput w-52 resize-none"></textarea>
                  </div>

                  <button onclick="finalSubmit()"
                    class="bg-teal-600 hover:bg-teal-700
                           text-white px-6 py-2 rounded-md">
                    SAVE
                  </button>

                </div>

              </div>

            </td>
          </tr>
        </tfoot>

      </table>

    </div>


    <!-- âœ… MOBILE CARD VIEW -->
    <div class="block md:hidden space-y-4">

      <div id="mobileCards"></div>

      <!-- MOBILE FOOTER -->
      <div id="mobileFooterBox"
        class="hidden bg-white rounded-xl shadow border p-4 space-y-3">

        <div class="font-bold text-teal-700 text-lg">
          Total : <span id="mobileTotalQty">0</span>
        </div>

        <div>
          <label class="font-semibold text-sm">Delivery Status *</label>
          <select id="mobileDeliveryStatus" class="formInput">
            <option value="">Select</option>
            <option>Pending</option>
            <option>Completed</option>
          </select>
        </div>

        <div>
          <label class="font-semibold text-sm">Delivery Through *</label>
          <select id="mobileDeliveryThrough" class="formInput">
            <option value="">Select</option>
            <option>Own Vehicle</option>
            <option>Courier</option>
          </select>
        </div>

        <div>
          <label class="font-semibold text-sm">Vehicle No *</label>
          <input id="mobileVehicleNo"
            class="formInput"
            placeholder="TN01AB1234">
        </div>

        <div>
          <label class="font-semibold text-sm">Remarks</label>
          <textarea id="mobileRemarks"
            rows="2"
            class="formInput resize-none"></textarea>
        </div>

        <button onclick="finalSubmit()"
          class="w-full bg-teal-600 hover:bg-teal-700 text-white py-2 rounded-md">
          SAVE
        </button>

      </div>

    </div>

  </div>
</div>


<!-- âœ… MODAL -->
<div id="modal"
  class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">

  <div class="bg-white rounded-xl p-6 w-[90%] sm:w-[600px] space-y-4">

    <h2 class="text-xl font-bold text-teal-700">Add / Edit Challan Item</h2>

    <div class="grid grid-cols-2 gap-4">
      <input id="rowDate" type="datetime-local" class="formInput">
      <input id="particular" placeholder="Particulars" class="formInput">
      <input id="width" placeholder="Width" class="formInput">
      <input id="height" placeholder="Height" class="formInput">
      <input id="qty" placeholder="Qty" class="formInput">
    </div>

    <div class="flex justify-end gap-3 pt-4">
      <button onclick="closeModal()"
        class="px-4 py-2 bg-gray-200 rounded">
        Cancel
      </button>

      <button onclick="addRow()"
        class="px-5 py-2 bg-teal-600 text-white rounded">
        Save
      </button>
    </div>

  </div>
</div>


<!-- STYLE -->
<style>
.formInput {
  width: 100%;
  height: 42px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 0 12px;
}
.th {
  padding: 12px;
  font-weight: 600;
  text-align: center;
}
.td {
  padding: 10px;
  text-align: center;
}
</style>


<!-- SCRIPT -->
<script>
lucide.createIcons();

let rowCount = 0;
let editId = null;

function openModal() {
  modal.classList.remove("hidden");
}

function closeModal() {
  modal.classList.add("hidden");
  clearInputs();
  editId = null;
}

function clearInputs() {
  rowDate.value = "";
  particular.value = "";
  width.value = "";
  height.value = "";
  qty.value = "";
}

function addRow() {

  if (!rowDate.value || !particular.value || !qty.value) {
    alert("Fill required fields!");
    return;
  }

  if (editId) {

    let row = document.querySelector(`tr[data-id="${editId}"]`);
    row.children[1].innerText = rowDate.value;
    row.children[2].innerText = particular.value;
    row.children[5].innerText = qty.value;

    let card = document.querySelector(`div[data-id="${editId}"]`);
    card.querySelector(".cTitle").innerText = particular.value;
    card.querySelector(".cQty").innerText = qty.value;

    editId = null;

  } else {

    rowCount++;
    let id = rowCount;

    challanBody.insertAdjacentHTML("beforeend", `
      <tr data-id="${id}" class="border-t">
        <td class="td">${id}</td>
        <td class="td">${rowDate.value}</td>
        <td class="td">${particular.value}</td>
        <td class="td">${width.value}</td>
        <td class="td">${height.value}</td>
        <td class="td qty">${qty.value}</td>
        <td class="td flex justify-center gap-3">
          <span onclick="editRow(${id})" class="text-teal-600 cursor-pointer">Edit</span>
          <span onclick="deleteRow(${id})" class="text-red-600 cursor-pointer">Delete</span>
        </td>
      </tr>
    `);

    mobileCards.insertAdjacentHTML("beforeend", `
      <div data-id="${id}"
        class="bg-white border rounded-xl p-4 shadow space-y-2">

        <p class="font-bold text-emerald-700 cTitle">${particular.value}</p>

        <p><b>Date:</b> ${rowDate.value}</p>
        <p><b>Qty:</b> <span class="cQty">${qty.value}</span></p>

        <div class="flex justify-end gap-4 pt-2">
          <button onclick="editRow(${id})"
            class="text-teal-600 font-semibold text-sm">Edit</button>

          <button onclick="deleteRow(${id})"
            class="text-red-600 font-semibold text-sm">Delete</button>
        </div>

      </div>
    `);
  }

  updateTotal();
  closeModal();
}

function editRow(id) {

  editId = id;

  let row = document.querySelector(`tr[data-id="${id}"]`);

  rowDate.value = row.children[1].innerText;
  particular.value = row.children[2].innerText;
  qty.value = row.children[5].innerText;

  openModal();
}

function deleteRow(id) {

  document.querySelector(`tr[data-id="${id}"]`).remove();
  document.querySelector(`div[data-id="${id}"]`).remove();

  updateTotal();
}

function updateTotal() {

  let total = 0;
  document.querySelectorAll(".qty").forEach(q => {
    total += Number(q.innerText) || 0;
  });

  totalQty.innerText = total;
  mobileTotalQty.innerText = total;
  grandTotal.value = total;

  footerBox.classList.toggle("hidden", total === 0);
  mobileFooterBox.classList.toggle("hidden", total === 0);
}

function finalSubmit() {

  let status = window.innerWidth < 768
    ? mobileDeliveryStatus.value
    : deliveryStatus.value;

  let through = window.innerWidth < 768
    ? mobileDeliveryThrough.value
    : deliveryThrough.value;

  let vehicle = window.innerWidth < 768
    ? mobileVehicleNo.value
    : vehicleNo.value;

  if (!status || !through || !vehicle) {
    alert("Please fill Delivery Status, Through & Vehicle No ðŸšš");
    return;
  }

  alert("Fabric Delivery Challan Saved Successfully âœ…");
}
</script>

{% endblock %}
