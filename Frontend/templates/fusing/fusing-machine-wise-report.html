{% extends "nav.html" %}

{% block title %}Machine Wise Report{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  .btnReset {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    height: 48px;
    min-width: 150px;
    padding: 0 20px;
    border-radius: 12px;
    background: #e5e7eb;
    font-weight: 700;
  }

  .btnSearch {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    height: 48px;
    min-width: 150px;
    padding: 0 20px;
    border-radius: 12px;
    background: #0d9488;
    color: #fff;
    font-weight: 700;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50 p-6">
  <div class="max-w-[1600px] mx-auto space-y-6">

    <!-- HEADER -->
    <div class="bg-gradient-to-r from-teal-600 to-cyan-600 rounded-xl p-6 shadow
                flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
          <i data-lucide="settings" class="text-white"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-white">Machine Wise Report</h1>
          <p class="text-teal-100 text-sm">Production summary by machine</p>
        </div>
      </div>

      <button onclick="window.print()" class="bg-white text-teal-700 px-4 py-2 rounded-lg flex items-center gap-2">
        <i data-lucide="printer"></i> Print Report
      </button>
    </div>

    <!-- FILTERS -->
    <div class="bg-white rounded-xl shadow p-6 grid grid-cols-1 sm:grid-cols-4 gap-4">
      <div>
        <label class="text-sm text-slate-600">From Date</label>
        <input type="date" id="fromDate" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="text-sm text-slate-600">To Date</label>
        <input type="date" id="toDate" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="text-sm text-slate-600">Machine No</label>
        <input id="machine" list="machineList" placeholder="Type Machine No" class="w-full border rounded px-3 py-2">
        <datalist id="machineList">
          <option value="FLAT BED NO 3">
          <option value="FLAT BED NO 4">
          <option value="ROLL TO ROLL NO 1">
        </datalist>
      </div>

      <div class="flex items-end gap-3">
        <button id="searchBtn" class="btnSearch">
          <i data-lucide="search"></i> Search
        </button>
        <button id="resetBtn" class="btnReset">
          <i data-lucide="rotate-ccw"></i> Reset
        </button>
      </div>
    </div>

    <!-- TABLE -->
    <div class="bg-white rounded-xl shadow overflow-x-auto">
      <table class="w-full min-w-[900px] text-sm">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3">S.No</th>
            <th class="p-3">Date</th>
            <th class="p-3">Jobcard No</th>
            <th class="p-3">Shift</th>
            <th class="p-3">Machine No</th>
            <th class="p-3">Operator Name</th>
            <th class="p-3">Particular</th>
            <th class="p-3 text-right">Order Qty</th>
            <th class="p-3 text-right">Product Qty</th>
            <th class="p-3 text-right">Balance Qty</th>
          </tr>
        </thead>

        <tbody id="tableBody"></tbody>

        <tfoot class="bg-slate-50 font-semibold">
          <tr>
            <td colspan="7" class="p-3 text-right">Total</td>
            <td class="p-3 text-right" id="tOrder">0.00</td>
            <td class="p-3 text-right" id="tProd">0.00</td>
            <td class="p-3 text-right" id="tBal">0.00</td>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  lucide.createIcons();

  /* ✅ SAMPLE DATA (later backend connect panna replace pannalam) */
  const rows = [
    {
      date: "03-04-2024", jc: "JC-001", shift: "DAY", mach: "FLAT BED NO 3",
      op: "Golu Kumar", part: "XL-5 DESIGN", order: 1500, produced: 600, balance: 900
    },

    {
      date: "04-04-2024", jc: "JC-002", shift: "DAY", mach: "FLAT BED NO 4",
      op: "Rahul", part: "XL-6 DESIGN", order: 1600, produced: 900, balance: 700
    },

    {
      date: "05-04-2024", jc: "JC-003", shift: "NIGHT", mach: "FLAT BED NO 3",
      op: "Anand", part: "XL-7 DESIGN", order: 1200, produced: 300, balance: 900
    }
  ];

  const tbody = document.getElementById("tableBody");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const machineEl = document.getElementById("machine");

  const tOrderEl = document.getElementById("tOrder");
  const tProdEl = document.getElementById("tProd");
  const tBalEl = document.getElementById("tBal");

  function toISO(ddmmyyyy) {
    // "03-04-2024" -> "2024-04-03"
    const [dd, mm, yyyy] = ddmmyyyy.split("-");
    return `${yyyy}-${mm}-${dd}`;
  }

  function clearTable() {
    tbody.innerHTML = `
    <tr class="border-t">
      <td class="p-3 text-center text-slate-500" colspan="10">
        Enter Machine No to view records
      </td>
    </tr>
  `;
    tOrderEl.textContent = "0.00";
    tProdEl.textContent = "0.00";
    tBalEl.textContent = "0.00";
  }

  function renderTable(data) {
    tbody.innerHTML = "";
    let tO = 0, tP = 0, tB = 0;

    if (data.length === 0) {
      tbody.innerHTML = `
      <tr class="border-t">
        <td class="p-3 text-center text-slate-500" colspan="10">
          No records found
        </td>
      </tr>
    `;
      tOrderEl.textContent = "0.00";
      tProdEl.textContent = "0.00";
      tBalEl.textContent = "0.00";
      return;
    }

    data.forEach((r, i) => {
      tO += Number(r.order) || 0;
      tP += Number(r.produced) || 0;
      tB += Number(r.balance) || 0;

      tbody.innerHTML += `
      <tr class="border-t hover:bg-slate-50">
        <td class="p-3">${i + 1}</td>
        <td class="p-3">${r.date}</td>
        <td class="p-3">${r.jc}</td>
        <td class="p-3">${r.shift}</td>
        <td class="p-3">${r.mach}</td>
        <td class="p-3">${r.op}</td>
        <td class="p-3">${r.part}</td>
        <td class="p-3 text-right">${r.order}</td>
        <td class="p-3 text-right">${r.produced}</td>
        <td class="p-3 text-right">${r.balance}</td>
      </tr>
    `;
    });

    tOrderEl.textContent = tO.toFixed(2);
    tProdEl.textContent = tP.toFixed(2);
    tBalEl.textContent = tB.toFixed(2);
  }

  function applyFilters() {
    const mach = (machineEl.value || "").trim().toLowerCase();

    // ✅ IMPORTANT: machine empty na table show pannakoodadhu
    if (!mach) {
      clearTable();
      return;
    }

    const from = fromDate.value; // yyyy-mm-dd
    const to = toDate.value;   // yyyy-mm-dd

    const filtered = rows.filter(r => {
      // machine filter
      if (!r.mach.toLowerCase().includes(mach)) return false;

      // date filter (optional)
      const iso = toISO(r.date);
      if (from && iso < from) return false;
      if (to && iso > to) return false;

      return true;
    });

    renderTable(filtered);
  }

  // ✅ initial: table blank message
  clearTable();

  // ✅ search click
  document.getElementById("searchBtn").addEventListener("click", applyFilters);

  // ✅ live typing: machine type panna udane show
  machineEl.addEventListener("input", applyFilters);

  // ✅ date change pannalum auto filter (machine irundha)
  fromDate.addEventListener("change", applyFilters);
  toDate.addEventListener("change", applyFilters);

  // ✅ reset => everything clear + table blank
  document.getElementById("resetBtn").addEventListener("click", (e) => {
    e.preventDefault();
    fromDate.value = "";
    toDate.value = "";
    machineEl.value = "";
    clearTable();
  });
</script>
{% endblock %}