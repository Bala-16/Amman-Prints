{% extends "nav.html" %}

{% block title %}Job Card List{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  @media print {
    body * {
      visibility: hidden;
    }
    #printArea, #printArea * {
      visibility: visible;
    }
    #printArea {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-teal-50/30 to-cyan-50/30 p-4 sm:p-6">

  <div class="max-w-[1600px] mx-auto space-y-6">

    <!-- HEADER -->
    <div class="bg-gradient-to-r from-teal-600 via-cyan-600 to-teal-600 rounded-xl p-4 sm:p-6 shadow-xl flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 flex items-center justify-center rounded-xl bg-white/20">
          <i data-lucide="file-text" class="text-white w-6 h-6"></i>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-bold text-white"> Jobcard Wise Report</h1>
          <p class="text-teal-100 text-sm sm:text-base">Production details per jobcard</p>
        </div>
      </div>

      <button onclick="window.print()"
        class="bg-white text-teal-600 px-4 py-2 rounded-lg shadow flex items-center gap-2 hover:scale-105 transition">
        <i data-lucide="printer" class="w-4 h-4"></i>
        Print
      </button>
    </div>

    <!-- FILTERS -->
    <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4 sm:p-6 grid grid-cols-1 sm:grid-cols-5 gap-4">
      <div>
        <label class="text-sm">From Date</label>
        <input type="date" id="fromDate" class="w-full border rounded px-3 py-2 text-sm sm:text-base">
      </div>
      <div>
        <label class="text-sm">To Date</label>
        <input type="date" id="toDate" class="w-full border rounded px-3 py-2 text-sm sm:text-base">
      </div>
      <div>
        <label class="text-sm">Jobcard No</label>
        <input type="text" id="jobcardFilter" class="w-full border rounded px-3 py-2 text-sm sm:text-base" placeholder="JC-2404-0004">
      </div>
      <div>
        <label class="text-sm">Machine</label>
        <select id="machineFilter" class="w-full border rounded px-3 py-2 text-sm sm:text-base">
          <option value="">All</option>
          <option>FLAT BED NO 1</option>
          <option>FLAT BED NO 2</option>
        </select>
      </div>
      <div class="flex items-end">
        <button id="searchBtn" class="bg-teal-600 text-white px-4 sm:px-6 py-2 rounded-lg flex items-center gap-2 hover:bg-teal-700 transition">
          <i data-lucide="search" class="w-4 h-4"></i>
          Search
        </button>
      </div>
    </div>

    <!-- PRINT AREA -->
    <div id="printArea" class="space-y-6">

      <!-- CHARTS -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
        <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 sm:p-10 h-[280px]">
          <h3 class="font-semibold mb-4 text-sm sm:text-base">Jobcard vs Production Qty</h3>
          <canvas id="jobcardBarChart"></canvas>
        </div>

        <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 sm:p-10 h-[280px]">
          <h3 class="font-semibold mb-4 text-sm sm:text-base">Jobcard Distribution</h3>
          <canvas id="jobcardPieChart"></canvas>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6">
        <div class="bg-white rounded-xl shadow p-4 text-center sm:text-left">
          <p class="text-sm text-slate-500">Total Order Qty</p>
          <h2 id="totalOrder" class="text-xl sm:text-2xl font-bold">0</h2>
        </div>
        <div class="bg-white rounded-xl shadow p-4 text-center sm:text-left">
          <p class="text-sm text-slate-500">Total Produced</p>
          <h2 id="totalProduced" class="text-xl sm:text-2xl font-bold">0</h2>
        </div>
        <div class="bg-white rounded-xl shadow p-4 text-center sm:text-left">
          <p class="text-sm text-slate-500">Balance</p>
          <h2 id="balanceQty" class="text-xl sm:text-2xl font-bold">0</h2>
        </div>
      </div>

      <!-- TABLE -->
      <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg overflow-x-auto">
        <table class="w-full text-sm sm:text-base min-w-[700px]">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2 sm:p-3 text-left">Date</th>
              <th class="p-2 sm:p-3 text-left">Jobcard No</th>
              <th class="p-2 sm:p-3 text-left">Shift</th>
              <th class="p-2 sm:p-3 text-left">Operator</th>
              <th class="p-2 sm:p-3 text-left">Machine</th>
              <th class="p-2 sm:p-3 text-left">Particular</th>
              <th class="p-2 sm:p-3 text-right">Order Qty</th>
              <th class="p-2 sm:p-3 text-right">Produced Qty</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

    </div>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
lucide.createIcons()

const rows = [
  {date:"03-04-2024", jc:"JC-2404-0004", shift:"DAY", op:"GOLU KUMAR", mach:"FLAT BED NO 1", part:"XL-5 DESIGN", order:1500, produced:600},
  {date:"04-04-2024", jc:"JC-2404-0005", shift:"NIGHT", op:"RAHUL", mach:"FLAT BED NO 2", part:"AOP TOP", order:1200, produced:800},
  {date:"05-04-2024", jc:"JC-2404-0006", shift:"DAY", op:"SURESH", mach:"FLAT BED NO 1", part:"L TOP", order:1000, produced:700},
]

// Get table and summary elements
const tbody = document.getElementById("tableBody")
const totalOrder = document.getElementById("totalOrder")
const totalProduced = document.getElementById("totalProduced")
const balanceQty = document.getElementById("balanceQty")

// Initialize charts
let barChart, pieChart

function renderTable(data){
  tbody.innerHTML = ""
  let orderSum = 0, producedSum = 0
  data.forEach(r=>{
    tbody.innerHTML += `
      <tr class="border-t hover:bg-slate-50">
        <td class="p-2 sm:p-3">${r.date}</td>
        <td class="p-2 sm:p-3">${r.jc}</td>
        <td class="p-2 sm:p-3">${r.shift}</td>
        <td class="p-2 sm:p-3">${r.op}</td>
        <td class="p-2 sm:p-3">${r.mach}</td>
        <td class="p-2 sm:p-3">${r.part}</td>
        <td class="p-2 sm:p-3 text-right">${r.order}</td>
        <td class="p-2 sm:p-3 text-right">${r.produced}</td>
      </tr>
    `
    orderSum += r.order
    producedSum += r.produced
  })
  totalOrder.textContent = orderSum
  totalProduced.textContent = producedSum
  balanceQty.textContent = orderSum - producedSum

  // Update charts
  const labels = data.map(r=>r.jc)
  const quantities = data.map(r=>r.produced)
  if(barChart) barChart.destroy()
  if(pieChart) pieChart.destroy()

  barChart = new Chart(document.getElementById("jobcardBarChart"), {
    type:"bar",
    data:{labels, datasets:[{label:"Produced Qty", data:quantities, backgroundColor:"#0d9488", borderRadius:6}]},
    options:{maintainAspectRatio:false, responsive:true, scales:{y:{beginAtZero:true}}}
  })

  pieChart = new Chart(document.getElementById("jobcardPieChart"), {
    type:"doughnut",
    data:{labels, datasets:[{data:quantities, backgroundColor:["#0d9488","#14b8a6","#5eead4"]}]},
    options:{maintainAspectRatio:false, responsive:true}
  })
}

// Initial render
renderTable(rows)

// Filter/search
document.getElementById("searchBtn").addEventListener("click",()=>{
  const from = document.getElementById("fromDate").value
  const to = document.getElementById("toDate").value
  const jobcard = document.getElementById("jobcardFilter").value.toLowerCase()
  const machine = document.getElementById("machineFilter").value

  const filtered = rows.filter(r=>{
    const matchFrom = !from || r.date >= from
    const matchTo = !to || r.date <= to
    const matchJC = !jobcard || r.jc.toLowerCase().includes(jobcard)
    const matchMachine = !machine || r.mach === machine
    return matchFrom && matchTo && matchJC && matchMachine
  })

  renderTable(filtered)
})
</script>
{% endblock %}
