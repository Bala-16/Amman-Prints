{% extends "nav.html" %}
{% block title %}Fusing Production Entry{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --bg1: #f6fbff;
    --bg2: #f3fbf8;
    --card: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --muted2: #94a3b8;
    --line: #e6edf5;
    --shadow: 0 10px 28px rgba(2, 44, 66, .10);
    --shadowSoft: 0 6px 16px rgba(2, 44, 66, .08);
    --teal1: #0ea5a6;
    --teal2: #16b3a8;
    --teal3: #0f8ea0;
    --green1: #16a34a;
    --green2: #22c55e;
    --danger: #ef4444;
    --radius: 18px;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    color: var(--text);
  }

  .page {
    min-height: 100vh;
    padding: 18px;
    background:
      radial-gradient(1200px 600px at 25% 0%, rgba(14, 165, 166, .14), transparent 60%),
      radial-gradient(1000px 500px at 80% 10%, rgba(22, 179, 168, .12), transparent 55%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
  }

  .wrap {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Header */
  .hero {
    border-radius: 22px;
    background: linear-gradient(135deg, var(--teal1), var(--teal2) 55%, var(--teal3));
    box-shadow: var(--shadow);
    padding: 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 14px;
    color: #fff;
  }

  .hero-left {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 0;
  }

  .hero-icon {
    width: 46px;
    height: 46px;
    border-radius: 14px;
    display: grid;
    place-items: center;
    background: rgba(255, 255, 255, .16);
    flex: 0 0 auto;
  }

  .hero-title {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .hero-title h1 {
    margin: 0;
    font-size: 25px;
    line-height: 1.15;
    letter-spacing: .2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .hero-title p {
    margin: 0;
    opacity: .92;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Buttons */
  .btn {
    border: 0;
    cursor: pointer;
    border-radius: 14px;
    padding: 11px 16px;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: transform .08s ease, filter .15s ease;
    user-select: none;
  }

  .btn:active {
    transform: translateY(1px);
  }

  .btn.light {
    background: rgba(255, 255, 255, .18);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, .25);
  }

  .btn.primary {
    background: linear-gradient(135deg, var(--green1), var(--green2));
    color: #fff;
    box-shadow: var(--shadowSoft);
  }

  .btn.ghost {
    background: #fff;
    color: #0f172a;
    border: 1px solid var(--line);
  }

  .btn.small {
    padding: 9px 14px;
    border-radius: 12px;
    font-size: 14px;
  }

  .btn.icon {
    padding: 10px 10px;
    border-radius: 12px;
    background: #fff;
    border: 1px solid var(--line);
    box-shadow: none;
  }

  .btn.icon.edit {
    color: #059669;
  }

  .btn.icon.del {
    color: #ef4444;
  }

  /* Card */
  .card {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .card-head {
    padding: 18px 18px;
    border-bottom: 1px solid var(--line);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 10px;
    background: linear-gradient(180deg, rgba(14, 165, 166, .06), transparent);
  }

  .card-head h2 {
    margin: 0;
    font-size: 20px;
    letter-spacing: .2px;
  }

  .subtxt {
    margin-top: 6px;
    font-size: 14px;
    color: var(--muted);
    font-weight: 700;
  }

  .card-body {
    padding: 18px;
  }

  /* Job Details grid (keep like earlier) */
  .grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 18px 22px;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .labelRow {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #475569;
    font-weight: 900;
    font-size: 14px;
  }

  .labelRow svg {
    width: 20px !important;
    height: 20px !important;
    color: #64748b !important;
    stroke: #64748b !important;
    flex: 0 0 auto;
  }

  .req {
    color: var(--danger);
    font-weight: 900;
    margin-left: 3px;
  }

  .control {
    width: 100%;
    border: 1px solid #dbe7f3;
    background: #fff;
    border-radius: 12px;
    padding: 13px 14px;
    outline: none;
    font-size: 15px;
    transition: border .15s ease, box-shadow .15s ease;
  }

  .control:focus {
    border-color: rgba(14, 165, 166, .55);
    box-shadow: 0 0 0 4px rgba(14, 165, 166, .12);
  }

  /* Table like your screenshot */
  .table-wrap {
    overflow: auto;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 1100px;
  }

  thead th {
    background: #f3f6f9;
    color: #0f172a;
    font-size: 15px;
    font-weight: 900;
    padding: 16px 16px;
    border-bottom: 1px solid #e5edf6;
    white-space: nowrap;
  }

  tbody td {
    padding: 18px 16px;
    border-bottom: 1px solid #e9f0f8;
    font-size: 16px;
    color: #0f172a;
    white-space: nowrap;
    vertical-align: middle;
  }

  tbody tr:last-child td {
    border-bottom: 0;
  }

  tbody tr:hover td {
    background: #fbfdff;
  }

  .num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .total-row td {
    background: #f8fbff;
    font-weight: 900;
  }

  /* Bottom row inside production card (status + submit) */
  .prod-bottom {
    padding: 18px;
    border-top: 1px solid var(--line);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 14px;
    flex-wrap: wrap;
    background: linear-gradient(180deg, transparent, rgba(2, 44, 66, .02));
  }

  .statusBox {
    min-width: 360px;
    max-width: 520px;
    width: 40%;
  }

  .statusTitle {
    font-weight: 900;
    font-size: 16px;
    margin-bottom: 10px;
  }

  .submitBtn {
    min-width: 190px;
    justify-content: center;
    font-size: 16px;
    padding: 13px 18px;
    border-radius: 16px;
  }

  /* Modal (your 2nd image style) */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, .55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 9999;
  }

  .modal-backdrop.show {
    display: flex;
  }

  .modal {
    width: min(920px, 100%);
    background: #fff;
    border-radius: 22px;
    box-shadow: 0 30px 80px rgba(2, 44, 66, .35);
    overflow: hidden;
  }

  .modal-head {
    padding: 18px 22px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--line);
  }

  .modal-head h3 {
    margin: 0;
    font-size: 26px;
    letter-spacing: .2px;
  }

  .close-x {
    border: 0;
    background: transparent;
    cursor: pointer;
    padding: 8px;
    border-radius: 12px;
  }

  .close-x:hover {
    background: #f3f6f9;
  }

  .modal-body {
    padding: 18px 22px 8px;
  }

  .modal-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 18px 22px;
  }

  .span2 {
    grid-column: 1 / -1;
  }

  .modal-actions {
    padding: 18px 22px 22px;
    display: flex;
    justify-content: center;
    gap: 18px;
  }

  .btn.cancel {
    background: #fff;
    color: #0f172a;
    border: 1px solid var(--line);
    box-shadow: none;
    min-width: 160px;
    justify-content: center;
  }

  .btn.add {
    background: linear-gradient(135deg, var(--teal2), var(--teal1));
    color: #fff;
    min-width: 180px;
    justify-content: center;
  }

  @media (max-width: 1200px) {
    .grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (max-width: 760px) {
    .page {
      padding: 12px;
    }

    .hero {
      padding: 14px;
      flex-direction: column;
      align-items: stretch;
    }

    .grid {
      grid-template-columns: 1fr;
    }

    .modal-grid {
      grid-template-columns: 1fr;
    }

    .statusBox {
      width: 100%;
      min-width: 0;
    }

    .submitBtn {
      width: 100%;
    }

    .modal-actions {
      flex-direction: column;
    }

    .btn.cancel,
    .btn.add {
      width: 100%;
    }
  }

  /* ✅ Mobile: Job Details side-by-side (desktop no change) */
  @media (max-width: 640px) {
    .job-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      gap: 14px 14px !important;
    }

    .job-grid .field.half-m {
      grid-column: span 1 !important;
    }

    .job-grid .field.full-m {
      grid-column: 1 / -1 !important;
    }
  }

  /* ✅ Desktop: keep normal */
  .prod-table {
    overflow: auto;
  }

  /* ✅ Mobile: make rows as cards (NO horizontal scroll) */
  @media (max-width: 640px) {

    /* ✅ Desktop: keep normal */
    .prod-table {
      overflow: auto;
    }

    /* ✅ Mobile: card view like your 2nd image (label left, value right) */
    @media (max-width: 640px) {

      .prod-table {
        overflow: visible !important;
      }

      .prod-table-table {
        min-width: 0 !important;
      }

      /* hide table header */
      .prod-table-table thead {
        display: none !important;
      }

      /* table => blocks */
      .prod-table-table,
      .prod-table-table tbody,
      .prod-table-table tr,
      .prod-table-table td {
        display: block !important;
        width: 100% !important;
      }

      /* each row = CARD */
      .prod-table-table tbody tr {
        margin: 12px 12px;
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadowSoft);
        overflow: hidden;
      }

      /* each cell = ONE LINE (label left, value right) */
      .prod-table-table tbody td {
        border: 0 !important;
        padding: 10px 14px !important;
        white-space: normal !important;

        display: flex !important;
        align-items: flex-start !important;
        justify-content: space-between !important;
        gap: 14px !important;
      }

      /* label (left) */
      .prod-table-table tbody td::before {
        content: attr(data-label);
        display: block !important;
        color: #64748b;
        font-weight: 900;
        font-size: 13px;
        flex: 0 0 40%;
        min-width: 120px;
      }

      /* value (right) */
      .prod-table-table tbody td {
        font-weight: 700;
      }

      /* long text wrap (Size etc.) */
      .prod-table-table tbody td:nth-child(5) {
        align-items: flex-start !important;
      }

      /* numbers align right like card */
      .prod-table-table tbody td.num {
        text-align: right !important;
      }

      /* (since your num class is on td) */
      .prod-table-table tbody td.num::before {
        text-align: left !important;
      }

      /* Action row bottom like 2nd image */
      .prod-table-table tbody td.action-cell {
        justify-content: flex-end !important;
        padding: 12px 14px !important;
        border-top: 1px solid var(--line) !important;
        background: #f8fbff;
      }

      .prod-table-table tbody td.action-cell::before {
        content: "Action";
        flex: 1 1 auto;
        min-width: unset;
      }

      /* Total row – make it look neat in card */
      .prod-table-table .total-row td {
        background: #f8fbff !important;
        font-weight: 900 !important;
      }
    }
  }



  /* ✅ Mobile: show cards, hide table (desktop no change) */
  .mob-cards {
    display: none;
  }

  @media (max-width: 640px) {

    /* hide table in mobile */
    .prod-table {
      display: none !important;
    }

    /* show cards */
    .mob-cards {
      display: flex !important;
      flex-direction: column;
      gap: 14px;
      padding: 14px 12px 6px;
    }

    .mcard {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadowSoft);
      padding: 14px 14px 12px;
      position: relative;
    }

    .mhead {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .mdate {
      font-weight: 900;
      font-size: 16px;
      color: var(--text);
    }

    .micons {
      display: flex;
      gap: 10px;
    }

    .micons .btn.icon {
      padding: 9px 9px;
      border-radius: 12px;
    }

    .msub {
      margin-top: 4px;
      color: var(--muted);
      font-weight: 800;
      font-size: 12.5px;
      letter-spacing: .2px;
    }

    .mline {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .mline b {
      font-weight: 900;
    }

    .mline span {
      font-weight: 800;
      color: var(--text);
    }

    .mmetrics {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .mbox {
      background: #f4f7fb;
      border: 1px solid #e7eef6;
      border-radius: 12px;
      padding: 10px 10px 9px;
      text-align: center;
    }

    .mbox .k {
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }

    .mbox .v {
      margin-top: 4px;
      font-weight: 900;
      font-size: 14px;
      color: var(--text);
    }
  }

  /* ✅ Print button -> Sample Jobcard style (white pill) */
  .btn.report {
    background: #ffffff !important;
    color: #0ea5a6 !important;
    /* purple text like sample */
    border: 0 !important;
    box-shadow: 0 10px 22px rgba(2, 44, 66, .14) !important;
    padding: 12px 18px !important;
    border-radius: 16px !important;
    font-weight: 900 !important;
  }

  .btn.report svg {
    width: 18px !important;
    height: 18px !important;
    color: #0ea5a6 !important;
    stroke: #0ea5a6 !important;
  }

  /* ✅ Mobile-la full width bar varaama compact-a iruka */
  @media (max-width: 760px) {
    .btn.report {
      width: fit-content !important;
      align-self: flex-start !important;
      /* hero column aanaalum left-la irukum */
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="page">
  <div class="wrap">

    <!-- Header -->
    <div class="hero">
      <div class="hero-left">
        <div class="hero-icon"><i data-lucide="factory"></i></div>
        <div class="hero-title">
          <h1>Fusing Production Entry</h1>
          <p>Manage daily fusing production details</p>
        </div>
      </div>
      <button type="button" class="btn report" onclick="window.print()">
        <i data-lucide="printer"></i> Print Report
      </button>

    </div>

    <!-- FORM -->
    <form id="fusingForm" method="post" class="card" autocomplete="off">
      {% csrf_token %}

      <!-- Job Details (unchanged) -->
      <div class="card-head">
        <div>
          <h2>Job Details</h2>
        </div>
      </div>

      <div class="card-body">
        <div class="grid job-grid">

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="file-text"></i> Jobcard No <span class="req">*</span></div>
            <input class="control" name="jobcard_no" type="text" required value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="users"></i> Customer Name</div>
            <input class="control" name="customer_name" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="tag"></i> Style No</div>
            <input class="control" name="style_no" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="layers"></i> Job Type</div>
            <input class="control" name="job_type" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="user"></i> Job Created by</div>
            <input class="control" name="job_created_by" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="shirt"></i> Style Name</div>
            <input class="control" name="style_name" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="layers-3"></i> Fabric Type</div>
            <input class="control" name="fabric_type" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="hash"></i> Customer PO No</div>
            <input class="control" name="customer_po_no" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="palette"></i> Combo</div>
            <input class="control" name="combo" type="text" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="calculator"></i> Printed Qty</div>
            <input class="control" name="printed_qty" type="number" min="0" step="1" value="">
          </div>

          <div class="field half-m">
            <div class="labelRow"><i data-lucide="calendar"></i> Date</div>
            <input class="control" name="entry_date" type="text" value="">
          </div>

        </div>
      </div>

      <!-- Production Records (MAKE EXACT like your screenshot) -->
      <div class="card-head">
        <div>
          <h2>Production Records</h2>
          <div class="subtxt"><span id="foundCount">Found 0 Records</span></div>
        </div>

        <button type="button" class="btn primary" id="btnOpenModal">
          <i data-lucide="plus"></i> Add Entry
        </button>
      </div>

      <div class="table-wrap prod-table">
        <table class="prod-table-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Shift</th>
              <th>Machine</th>
              <th>Operator</th>
              <th>Size</th>
              <th class="num">T.Qty</th>
              <th class="num">P.Qty</th>
              <th class="num">Balance</th>
              <th>Action</th>
            </tr>
          </thead>

          <tbody id="prodBody">
            <!-- rows by JS -->
          </tbody>

          <tbody>
            <tr class="total-row">
              <td colspan="5">Total</td>
              <td class="num" id="totT">0.000</td>
              <td class="num" id="totP">0.000</td>
              <td class="num" id="totB">0.000</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mob-cards" id="prodCards"></div>

      <!-- Production Status + Submit inside same card (like screenshot) -->
      <div class="prod-bottom">
        <div class="statusBox">
          <div class="statusTitle">Production Status</div>
          <select class="control" name="fusing_status">
            <option value="Pending" selected>Pending</option>
            <option value="Completed">Completed</option>
            <option value="Hold">Hold</option>
          </select>
        </div>

        <button type="submit" class="btn primary submitBtn">
          SUBMIT
        </button>
      </div>

      <!-- Hidden JSON for backend -->
      <input type="hidden" name="production_rows_json" id="productionRowsJson" value="[]">
    </form>

  </div>
</div>

<!-- MODAL (Add Production) like your 2nd image -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <h3 id="modalTitle">Add Production</h3>
      <button type="button" class="close-x" id="btnCloseModal" aria-label="Close">
        <i data-lucide="x"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="modal-grid">
        <div class="field">
          <div class="labelRow">Date</div>
          <input class="control" type="text" id="m_date" placeholder="dd-mm-yyyy --:--">
        </div>

        <div class="field">
          <div class="labelRow">Shift <span class="req">*</span></div>
          <select class="control" id="m_shift">
            <option value="">--Select--</option>
            <option>DAY SHIFT</option>
            <option>NIGHT SHIFT</option>
          </select>
        </div>

        <div class="field">
          <div class="labelRow">Machine <span class="req">*</span></div>
          <input class="control" type="text" id="m_machine" placeholder="ROLL TO ROLL NO 1">
        </div>

        <div class="field">
          <div class="labelRow">Operator <span class="req">*</span></div>
          <input class="control" type="text" id="m_operator" placeholder="4">
        </div>

        <div class="field span2">
          <div class="labelRow">Size <span class="req">*</span></div>
          <input class="control" type="text" id="m_size" placeholder="ULTRA COLOUR BAG (58 x 37)">
        </div>

        <div class="field">
          <div class="labelRow">T.Qty</div>
          <input class="control" type="number" min="0" step="0.001" id="m_tqty" value="0">
        </div>

        <div class="field">
          <div class="labelRow">P.Qty <span class="req">*</span></div>
          <input class="control" type="number" min="0" step="0.001" id="m_pqty" value="0">
        </div>

        <div class="field span2">
          <div class="labelRow">Balance</div>
          <input class="control" type="text" id="m_balance" value="0.000" readonly>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn cancel" id="btnCancelModal">Cancel</button>
      <button type="button" class="btn add" id="btnModalAdd">ADD</button>
    </div>
  </div>
</div>

<script>
  // Lucide
  if (window.lucide) lucide.createIcons();

  // Utils
  const fmt3 = (n) => {
    const x = Number(n);
    return Number.isFinite(x) ? x.toFixed(3) : "0.000";
  };
  const num = (v) => {
    const x = Number(v);
    return Number.isFinite(x) ? x : 0;
  };
  const esc = (s) => String(s ?? "")
    .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;").replaceAll("'", "&#039;");

  // State
  let rows = [];
  let editIndex = -1;

  // Elements (table + totals)
  const prodBody = document.getElementById("prodBody");
  const foundCount = document.getElementById("foundCount");
  const totT = document.getElementById("totT");
  const totP = document.getElementById("totP");
  const totB = document.getElementById("totB");
  const rowsHidden = document.getElementById("productionRowsJson");

  // Modal elements
  const modalBackdrop = document.getElementById("modalBackdrop");
  const btnOpenModal = document.getElementById("btnOpenModal");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnCancelModal = document.getElementById("btnCancelModal");
  const btnModalAdd = document.getElementById("btnModalAdd");
  const modalTitle = document.getElementById("modalTitle");

  const mDate = document.getElementById("m_date");
  const mShift = document.getElementById("m_shift");
  const mMachine = document.getElementById("m_machine");
  const mOperator = document.getElementById("m_operator");
  const mSize = document.getElementById("m_size");
  const mTqty = document.getElementById("m_tqty");
  const mPqty = document.getElementById("m_pqty");
  const mBalance = document.getElementById("m_balance");

  function openModal(mode = "add", index = -1) {
    editIndex = index;
    modalTitle.textContent = (mode === "edit") ? "Edit Production" : "Add Production";

    if (mode === "edit" && rows[index]) {
      const r = rows[index];
      mDate.value = r.date || "";
      mShift.value = r.shift || "";
      mMachine.value = r.machine || "";
      mOperator.value = r.operator || "";
      mSize.value = r.size || "";
      mTqty.value = r.tqty ?? 0;
      mPqty.value = r.pqty ?? 0;
      mBalance.value = fmt3(num(mTqty.value) - num(mPqty.value));
    } else {
      clearModal();
    }

    modalBackdrop.classList.add("show");
    modalBackdrop.setAttribute("aria-hidden", "false");
    if (window.lucide) lucide.createIcons();
    setTimeout(() => mShift.focus(), 0);
  }

  function closeModal() {
    modalBackdrop.classList.remove("show");
    modalBackdrop.setAttribute("aria-hidden", "true");
    editIndex = -1;
  }

  function clearModal() {
    mDate.value = "";
    mShift.value = "";
    mMachine.value = "";
    mOperator.value = "";
    mSize.value = "";
    mTqty.value = 0;
    mPqty.value = 0;
    mBalance.value = "0.000";
  }

  function updateModalBalance() {
    mBalance.value = fmt3(num(mTqty.value) - num(mPqty.value));
  }
  mTqty.addEventListener("input", updateModalBalance);
  mPqty.addEventListener("input", updateModalBalance);

  btnOpenModal.addEventListener("click", () => openModal("add"));
  btnCloseModal.addEventListener("click", closeModal);
  btnCancelModal.addEventListener("click", closeModal);

  modalBackdrop.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalBackdrop.classList.contains("show")) closeModal();
  });

  function syncHidden() {
    rowsHidden.value = JSON.stringify(rows);
  }

  function calcTotals() {
    let t = 0, p = 0, b = 0;
    rows.forEach(r => {
      t += num(r.tqty);
      p += num(r.pqty);
      b += num(r.balance);
    });
    totT.textContent = fmt3(t);
    totP.textContent = fmt3(p);
    totB.textContent = fmt3(b);
  }

  function render() {
    // desktop table
    prodBody.innerHTML = "";

    // mobile cards
    const cards = document.getElementById("prodCards");
    if (cards) cards.innerHTML = "";

    rows.forEach((r, i) => {
      // ✅ Desktop table row (unchanged look)
      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td>${esc(r.date)}</td>
      <td>${esc(r.shift)}</td>
      <td>${esc(r.machine)}</td>
      <td>${esc(r.operator)}</td>
      <td>${esc(r.size)}</td>
      <td class="num">${fmt3(r.tqty)}</td>
      <td class="num">${fmt3(r.pqty)}</td>
      <td class="num">${fmt3(r.balance)}</td>
      <td>
        <button type="button" class="btn icon edit" data-edit="${i}" title="Edit">
      <i data-lucide="pencil"></i>
    </button>
        <button type="button" class="btn icon del" data-del="${i}" title="Delete">
          <i data-lucide="trash-2"></i>
        </button>
      </td>
    `;
      prodBody.appendChild(tr);

      // ✅ Mobile card (your 2nd image)
      if (cards) {
        const card = document.createElement("div");
        card.className = "mcard";
        card.innerHTML = `
      <div class="mhead">
  <div class="mdate">${esc(r.date || "")}</div>
  <div class="micons">
    <button type="button" class="btn icon edit" data-edit="${i}" title="Edit">
      <i data-lucide="pencil"></i>
    </button>
    <button type="button" class="btn icon del" data-del="${i}" title="Delete">
      <i data-lucide="trash-2"></i>
    </button>
  </div>
</div>  

        <div class="mline"><b>Shift:</b> <span>${esc(r.shift || "")}</span></div>
        <div class="mline"><b>Machine:</b> <span>${esc(r.machine || "")}</span></div>


        <div class="mline"><b>Operator:</b> <span>${esc(r.operator || "")}</span></div>
        <div class="mline"><b>Size:</b> <span>${esc(r.size || "")}</span></div>

        <div class="mmetrics">
          <div class="mbox">
            <div class="k">T.Qty</div>
            <div class="v">${fmt3(r.tqty)}</div>
          </div>
          <div class="mbox">
            <div class="k">P.Qty</div>
            <div class="v">${fmt3(r.pqty)}</div>
          </div>
          <div class="mbox">
            <div class="k">Bal</div>
            <div class="v">${fmt3(r.balance)}</div>
          </div>
        </div>
      `;
        cards.appendChild(card);
      }
    });

    foundCount.textContent = `Found ${rows.length} Records`;

    // bind edit/delete for both table + cards
    document.querySelectorAll("[data-edit]").forEach(btn => {
      btn.onclick = () => openModal("edit", Number(btn.getAttribute("data-edit")));
    });
    document.querySelectorAll("[data-del]").forEach(btn => {
      btn.onclick = () => {
        const idx = Number(btn.getAttribute("data-del"));
        if (confirm("Delete this row?")) {
          rows.splice(idx, 1);
          syncHidden();
          calcTotals();
          render();
        }
      };
    });

    if (window.lucide) lucide.createIcons();
  }


  btnModalAdd.addEventListener("click", () => {
    if (!mShift.value || !mMachine.value || !mOperator.value || !mSize.value || mPqty.value === "") {
      alert("Shift, Machine, Operator, Size and P.Qty are required.");
      return;
    }

    const t = num(mTqty.value);
    const p = num(mPqty.value);
    const bal = t - p;

    const payload = {
      date: mDate.value || "",
      shift: mShift.value,
      machine: mMachine.value,
      operator: mOperator.value,
      size: mSize.value,
      tqty: t,
      pqty: p,
      balance: bal
    };

    if (editIndex >= 0) rows[editIndex] = payload;
    else rows.push(payload);

    syncHidden();
    calcTotals();
    render();
    closeModal();
  });

  // init
  updateModalBalance();
  syncHidden();
  calcTotals();
  render();
</script>
{% endblock %}