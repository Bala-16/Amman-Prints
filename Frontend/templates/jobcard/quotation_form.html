{% extends "nav.html" %}
{% block content %}

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
  }

  .form-header {
    background: #14b8a6;
    color: white;
    padding: 12px 20px;
    font-size: 20px;
    font-weight: bold;
  }

  .jobcard-no {
    text-align: center;
    margin: 15px 0;
    font-size: 18px;
    font-weight: bold;
  }

  .jobcard-no span {
    color: red;
  }

  .form-grid {
    width: 80%;
    margin: auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 50px;
  }

  .field-row {
    display: flex;
    align-items: center;
    margin-bottom: 18px;
  }

  .field-row label {
    width: 140px;
    font-weight: bold;
    font-size: 14px;
  }

  .field-row label span {
    color: red;
  }

  .field-row input,
  .field-row select {
    border: none;
    border-bottom: 1px solid gray;
    outline: none;
    width: 220px;
    padding: 5px;
    font-size: 14px;
    background: transparent;
  }

  .upload-icon {
    font-size: 20px;
    margin-left: 10px;
    cursor: pointer;
    color: #14b8a6;
  }

  .table-section {
    width: 90%;
    margin: 40px auto;
    border: 1px solid #ccc;
    background: white;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    background: #f2f2f2;
    border: 1px solid #ddd;
    padding: 8px;
    font-size: 14px;
  }

  td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
  }

  td input {
    width: 90%;
    border: none;
    outline: none;
    background: transparent;
  }

  .add-btn {
    background: #eee;
    border: 1px solid gray;
    padding: 4px 12px;
    cursor: pointer;
    font-size: 13px;
  }

  .total-row {
    text-align: center;
    font-weight: bold;
    padding: 15px;
  }

  .submit-btn {
    display: block;
    margin: 30px auto;
    background: #14b8a6;
    border: none;
    padding: 10px 40px;
    font-size: 15px;
    font-weight: bold;
    color: white;
    cursor: pointer;
  }

  .submit-btn:hover {
    background: #14b8a6;
  }

  .action-btns {
  display: flex;
  justify-content: center;
  gap: 6px;   /* space between buttons */
}

.action-btns button {
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
}
</style>

<!-- ✅ HEADER -->
<div class="form-header">
  Jobcard Quotation Form
</div>

<!-- ✅ Jobcard Number -->
<div class="jobcard-no">
  Jobcard No <span>{{ quotation_no }}</span>
</div>

<!-- ✅ FORM START -->
<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}

  <!-- ✅ TOP FORM GRID -->
  <div class="form-grid">

    <!-- LEFT SIDE -->
    <div>

      <div class="field-row">
         <label>Date</label>
         {{ form.date }}
      </div>


      <div class="field-row">
        <label>Customer Name<span>*</span></label>
        {{ form.customer_name }}

      </div>

      <!-- created_by user name show only (view la save panrom) -->
      <div class="field-row">
        <label>Job Created By<span>*</span></label>
        <input type="text" value="{{ request.user.username }}" readonly>
      </div>

      <div class="field-row">
        <label>Customer PO No</label>
        {{ form.customer_po_no }}

      </div>

      <div class="field-row">
        <label>Job Type</label>
        {{ form.job_type }}
      </div>

      <!-- ✅ IMPORTANT: name must be fabric_type -->
      <div class="field-row">
        <label>Fabric</label>
        {{ form.fabric_type }}
      </div>

      <div class="field-row">
        <label>Payment Terms<span>*</span></label>
        <select name="payment_terms" required>
          <option value="Cash">Cash</option>
          <option value="Credit">Credit</option>
        </select>
      </div>

    </div>

    <!-- RIGHT SIDE -->
    <div>

      <div class="field-row">
        <label>Order By</label>
        {{ form.order_by }}
      </div>

      <div class="field-row">
        <label>Style No<span>*</span></label>
        {{ form.style_no }}
      </div>

      <div class="field-row">
        <label>Style Name<span>*</span></label>
        {{ form.style_name }}
      </div>

      <div class="field-row">
        <label>Combo<span>*</span></label>
        {{ form.combo }}
      </div>

      <div class="field-row">
        <label>Image Upload</label>
        <input type="file" name="image">
        <span class="upload-icon">⬆</span>
      </div>

    </div>

  </div>

  <!-- ✅ PARTICULARS TABLE (currently only 1 row UI) -->
  <div class="table-section">
    <table>
      <thead>
        <tr>
          <th>S.No</th>
          <th>Particulars<span style="color:red">*</span></th>
          <th>Width<span style="color:red">*</span></th>
          <th>Height<span style="color:red">*</span></th>
          <th>Rate<span style="color:red">*</span></th>
          <th>Amt</th>
          <th>Confirmed Amt<span style="color:red">*</span></th>
          <th>Qty</th>
          <th>Value</th>
          <th>Action</th>
        </tr>
      </thead>

      <!-- <tbody> -->
      <tbody id="quotationBody">
        <tr>
          <td>1</td>
          <td><input type="text" name="particulars[]" ></td>
  <td><input type="number" step="0.01" name="width[]" class="width"></td>
  <td><input type="number" step="0.01" name="height[]" class="height"></td>
  <td><input type="number" step="0.01" name="rate[]" class="rate"></td>
  <td><input type="number" step="0.01" name="amt[]" class="amt" readonly></td>
  <td><input type="number" step="0.01" name="confirmed_amt[]" class="confirmed-amt"></td>
  <td><input type="number" name="qty[]" class="qty"></td>
  <td><input type="number" step="0.01" name="value[]" class="value" readonly></td>
  <td>
    <div class="action-btns">
      <button type="button" onclick="addRow()">ADD</button>
      <button type="button" onclick="deleteRow(this)">DEL</button>
    </div>
          <!-- <td><input type="text" name="particulars"></td>
          <td><input type="number" step="0.01" name="width"></td>
          <td><input type="number" step="0.01" name="height"></td>
          <td><input type="number" step="0.01" name="rate"></td>
          <td><input type="number" step="0.01" name="amt"></td>
          <td><input type="number" step="0.01" name="confirmed_amt"></td>
          <td><input type="number" name="qty"></td>
          <td><input type="number" step="0.01" name="value"></td>
          <td>
  <div class="action-btns">
    <button type="button" onclick="addRow()">ADD</button>
    <button type="button" onclick="deleteRow(this)">DEL</button>
  </div> -->
</td>
          <!-- <td><button type="button" class="add-btn">ADD</button></td> -->
        </tr>
      </tbody>
    </table>

    <div class="total-row">
      Total &nbsp;&nbsp;&nbsp; 0.00 &nbsp;&nbsp;&nbsp; 0.00
    </div>
  </div>

  <!-- Hidden total fields -->
  <input type="hidden" name="total_qty" value="0">
  <input type="hidden" name="total_value" value="0">

  <!-- ✅ SUBMIT BUTTON -->
  <button type="submit" class="submit-btn">
    SUBMIT
  </button>

</form>
{% include 'jobcard/party_modal.html' %}



<script>
function addRow() {
    let table = document.getElementById("quotationBody");
    let rowCount = table.rows.length;

    let row = table.insertRow();

    row.innerHTML = `
        <td>${rowCount + 1}</td>
        <td><input type="text" name="particulars[]"></td>
        <td><input type="number" step="0.01" name="width[]" class="width"></td>
        <td><input type="number" step="0.01" name="height[]" class="height"></td>
        <td><input type="number" step="0.01" name="rate[]" class="rate"></td>
        <td><input type="number" step="0.01" name="amt[]" class="amt" readonly></td>
        <td><input type="number" step="0.01" name="confirmed_amt[]" class="confirmed-amt"></td>
        <td><input type="number" name="qty[]" class="qty"></td>
        <td><input type="number" step="0.01" name="value[]" class="value" readonly></td>
        <td>
          <div class="action-btns">
            <button type="button" onclick="addRow()">ADD</button>
            <button type="button" onclick="deleteRow(this)">DEL</button>
          </div>
        </td>
    `;
}  

// function addRow() {
//     let table = document.getElementById("quotationBody");
//     let rowCount = table.rows.length;

//     let row = table.insertRow();

//     row.innerHTML = `
//         <td>${rowCount + 1}</td>
//         <td><input type="text" name="particulars[]"></td>
//         <td><input type="number" step="0.01" name="width[]"></td>
//         <td><input type="number" step="0.01" name="height[]"></td>
//         <td><input type="number" step="0.01" name="rate[]"></td>
//         <td><input type="number" step="0.01" name="amt[]" readonly></td>
//         <td><input type="number" step="0.01" name="confirmed_amt[]"></td>
//         <td><input type="number" name="qty[]"></td>
//         <td><input type="number" step="0.01" name="value[]" readonly></td>
//         <td>
//           <div class="action-btns">
           
//           <button type="button" class="add-btn" onclick="addRow()">ADD</button>
//           <button type="button" class="add-btn" onclick="deleteRow(this)">DEL</button>
//           </div>  
//         </td>
   
//     `;
// }

function deleteRow(btn) {
    btn.closest("tr").remove();
}


// function attachCalculationEvents() {
//     document.querySelectorAll('#tableBody tr').forEach(row => {
//         row.querySelectorAll('.width, .height, .rate, .confirmed-amt, .qty')
//             .forEach(input => {
//                 input.removeEventListener('input', calculateRow);
//                 input.addEventListener('input', calculateRow);
//             });
//     });
// }

// function calculateRow(e) {
//     const row = e.target.closest('tr');

//     const width = parseFloat(row.querySelector('.width').value) || 0;
//     const height = parseFloat(row.querySelector('.height').value) || 0;
//     const rate = parseFloat(row.querySelector('.rate').value) || 0;
//     const confirmedAmt = parseFloat(row.querySelector('.confirmed-amt').value) || 0;
//     const qty = parseFloat(row.querySelector('.qty').value) || 0;

//     const sq = width * height;
//     const amt = sq * rate;
//     const confirmedRate = sq !== 0 ? confirmedAmt / sq : 0;
//     const value = confirmedAmt * qty;

//     row.querySelector('.amt').value = amt.toFixed(2);
//     row.querySelector('.confirmed-rate').value = confirmedRate.toFixed(4);
//     row.querySelector('.value').value = value.toFixed(2);

//     calculateTotals();
// }

// function calculateTotals() {
//     let totalAmt = 0;
//     let totalConfirmedAmt = 0;
//     let totalValue = 0;

//     document.querySelectorAll('#tableBody tr').forEach(row => {
//         totalAmt += parseFloat(row.querySelector('.amt').value) || 0;
//         totalConfirmedAmt += parseFloat(row.querySelector('.confirmed-amt').value) || 0;
//         totalValue += parseFloat(row.querySelector('.value').value) || 0;
//     });

//     document.getElementById('totalAmt').value = totalAmt.toFixed(2);
//     document.getElementById('totalConfirmedAmt').value = totalConfirmedAmt.toFixed(2);
//     document.getElementById('totalValue').value = totalValue.toFixed(2);
// }

document.addEventListener("input", function(e) {

    let row = e.target.closest("tr");
    if (!row) return;

    let width = parseFloat(row.querySelector(".width")?.value) || 0;
    let height = parseFloat(row.querySelector(".height")?.value) || 0;
    let rate = parseFloat(row.querySelector(".rate")?.value) || 0;
    let confirmed = parseFloat(row.querySelector(".confirmed-amt")?.value) || 0;
    let qty = parseFloat(row.querySelector(".qty")?.value) || 0;

    let sq = width * height;
    let amt = sq * rate;
    let value = confirmed * qty;

    if (row.querySelector(".amt"))
        row.querySelector(".amt").value = amt.toFixed(2);

    if (row.querySelector(".value"))
        row.querySelector(".value").value = value.toFixed(2);

    calculateTotal();
});

function calculateTotal() {
    let totalQty = 0;
    let totalValue = 0;

    document.querySelectorAll(".qty").forEach(q => {
        totalQty += parseFloat(q.value) || 0;
    });

    document.querySelectorAll(".value").forEach(v => {
        totalValue += parseFloat(v.value) || 0;
    });

    document.querySelector("input[name='total_qty']").value = totalQty;
    document.querySelector("input[name='total_value']").value = totalValue.toFixed(2);
}

function deleteRow(button) {
    const row = button.closest('tr');
    const tableBody = document.getElementById('tableBody');

    if (tableBody.rows.length > 1) {
        row.remove();
        updateSerialNumbers();
        calculateTotals();
    }
}

function updateSerialNumbers() {
    document.querySelectorAll('#tableBody tr').forEach((row, index) => {
        row.cells[0].textContent = index + 1;
    });
}


</script>

{% endblock %} 