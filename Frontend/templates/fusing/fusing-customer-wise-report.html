{% extends "nav.html" %}

{% block title %}Job Card List{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-teal-50/30 to-cyan-50/30 p-4 sm:p-6">
  <div class="max-w-[1600px] mx-auto space-y-6">

    <!-- HEADER -->
    <div class="bg-gradient-to-r from-teal-600 via-cyan-600 to-teal-600 rounded-xl p-6 shadow-xl flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 flex items-center justify-center rounded-xl bg-white/20">
          <i data-lucide="layers" class="text-white w-6 h-6"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-white">Fusing Customer Wise Report</h1>
          <p class="text-teal-100 text-sm">Production summary by customer</p>
        </div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4 sm:p-6 grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="text-sm text-slate-600">From Date</label>
        <input type="date" id="fromDate" class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="text-sm text-slate-600">To Date</label>
        <input type="date" id="toDate" class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="text-sm text-slate-600">Customer Name</label>
        <input type="text" id="customerName" placeholder="TANGIBLES" class="w-full border rounded px-3 py-2">
      </div>
      <div class="flex items-end gap-2">
        <button id="searchBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg shadow hover:scale-105 transition flex items-center gap-2">
          <i data-lucide="search" class="w-4 h-4"></i> Search
        </button>
        <button id="resetBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg shadow hover:scale-105 transition flex items-center gap-2">
          Reset
        </button>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 sm:p-10 h-[260px]">
        <h3 class="font-semibold mb-2">Order vs Production</h3>
        <canvas id="barChart"></canvas>
      </div>

      <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 sm:p-10 h-[260px]">
        <h3 class="font-semibold mb-2">Balance Distribution</h3>
        <canvas id="pieChart"></canvas>
      </div>
    </div>

    <!-- TABLE -->
    <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg overflow-x-auto">
      <div class="p-4 border-b text-sm text-slate-600">
        Found <b id="recordCount">0</b> Records
      </div>

      <table class="w-full text-sm min-w-[800px]">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left">Date</th>
            <th class="p-3 text-left">Jobcard No</th>
            <th class="p-3 text-left">Customer</th>
            <th class="p-3 text-left">Shift</th>
            <th class="p-3 text-left">Machine</th>
            <th class="p-3 text-left">Operator</th>
            <th class="p-3 text-left">Particulars</th>
            <th class="p-3 text-right">Order Qty</th>
            <th class="p-3 text-right">Product Qty</th>
            <th class="p-3 text-right">Balance</th>
          </tr>
        </thead>
        <tbody id="customerTableBody"></tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
lucide.createIcons();

// Sample data
let customerData = [
  { date: "2024-04-03", jobcard: "JC-2404-0002", customer: "TANGIBLES", shift: "DAY (09–21)", machine: "FLAT BED NO 4", operator: "VINAY", particular: "70 – 6 Color Each", order: 233, produced: 235 },
  { date: "2024-04-04", jobcard: "JC-2404-0003", customer: "M.B GARMENTS", shift: "DAY (09–21)", machine: "FLAT BED NO 3", operator: "AJITH", particular: "65 – 6 Color Each", order: 300, produced: 200 }
];

const tableBody = document.getElementById("customerTableBody");
const fromDate = document.getElementById("fromDate");
const toDate = document.getElementById("toDate");
const customerName = document.getElementById("customerName");
const searchBtn = document.getElementById("searchBtn");
const resetBtn = document.getElementById("resetBtn");
const recordCount = document.getElementById("recordCount");

// Charts
const barCtx = document.getElementById("barChart").getContext("2d");
const pieCtx = document.getElementById("pieChart").getContext("2d");

let barChart = new Chart(barCtx, {
  type: "bar",
  data: { labels: [], datasets: [{ label: "Produced Qty", data: [], backgroundColor: "#14b8a6" }] },
  options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
});

let pieChart = new Chart(pieCtx, {
  type: "doughnut",
  data: { labels: ["Completed", "Balance"], datasets: [{ data: [], backgroundColor: ["#0d9488", "#f97316"] }] },
  options: { maintainAspectRatio: false }
});

// Render table and charts
function renderCustomer(data) {
  tableBody.innerHTML = "";
  let labels = [];
  let dataValues = [];
  let totalProduced = 0;
  let totalOrder = 0;

  data.forEach(row => {
    const balance = row.order - row.produced;
    tableBody.innerHTML += `
      <tr class="border-t hover:bg-slate-50">
        <td class="p-2 sm:p-3">${row.date}</td>
        <td class="p-2 sm:p-3">${row.jobcard}</td>
        <td class="p-2 sm:p-3">${row.customer}</td>
        <td class="p-2 sm:p-3">${row.shift}</td>
        <td class="p-2 sm:p-3">${row.machine}</td>
        <td class="p-2 sm:p-3">${row.operator}</td>
        <td class="p-2 sm:p-3">${row.particular}</td>
        <td class="p-2 sm:p-3 text-right">${row.order}</td>
        <td class="p-2 sm:p-3 text-right">${row.produced}</td>
        <td class="p-2 sm:p-3 text-right">${balance}</td>
      </tr>`;

    labels.push(row.customer);
    dataValues.push(row.produced);
    totalProduced += row.produced;
    totalOrder += row.order;
  });

  recordCount.innerText = data.length;

  barChart.data.labels = labels;
  barChart.data.datasets[0].data = dataValues;
  barChart.update();

  pieChart.data.datasets[0].data = [totalProduced, totalOrder - totalProduced];
  pieChart.update();
}

// Initial render
renderCustomer(customerData);

// Filter function
searchBtn.addEventListener("click", () => {
  const from = fromDate.value;
  const to = toDate.value;
  const customer = customerName.value.trim().toLowerCase();

  const filtered = customerData.filter(row => {
    let valid = true;
    if (from) valid = valid && row.date >= from;
    if (to) valid = valid && row.date <= to;
    if (customer) valid = valid && row.customer.toLowerCase().includes(customer);
    return valid;
  });

  renderCustomer(filtered);
});

// Reset filters
resetBtn.addEventListener("click", () => {
  fromDate.value = "";
  toDate.value = "";
  customerName.value = "";
  renderCustomer(customerData);
});
</script>
{% endblock %}
